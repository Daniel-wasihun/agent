<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pest Identification Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background: linear-gradient(to bottom, #e7f3e4, #c8e0c5);
            min-height: 100vh;
            font-family: 'Inter', sans-serif;
        }
        .chat-container {
            max-height: calc(100vh - 250px);
            overflow-y: auto;
            scroll-behavior: smooth;
        }
        .chat-message {
            max-width: 80%;
            margin: 10px;
            padding: 12px 16px;
            border-radius: 12px;
            line-height: 1.5;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .user-message {
            background-color: #4caf50;
            color: white;
            margin-left: auto;
        }
        .bot-message {
            background-color: #ffffff;
            color: #333;
            margin-right: auto;
        }
        .error-message {
            background-color: #fee2e2;
            color: #b91c1c;
            margin-right: auto;
        }
        .input-area {
            background: white;
            border-top: 1px solid #ddd;
            padding: 16px;
            position: sticky;
            bottom: 0;
        }
        #send-button:hover, #clear-button:hover {
            background-color: #45a049;
        }
        .report-content {
            white-space: pre-wrap;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }
        .report-header {
            font-weight: bold;
            margin-top: 12px;
            margin-bottom: 6px;
            font-size: 1.1em;
            cursor: pointer;
        }
        .report-subitem {
            margin-left: 16px;
            margin-bottom: 4px;
        }
        .collapsible {
            display: none;
        }
        .collapsible.active {
            display: block;
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4caf50;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 10px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #4caf50;
            border-radius: 4px;
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center">
    <div class="w-full max-w-2xl bg-white rounded-lg shadow-xl flex flex-col" style="height: 90vh;">
        <div class="bg-green-600 text-white p-4 rounded-t-lg flex items-center space-x-2">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 11c0-1.104-.896-2-2-2s-2 .896-2 2c0 .738.402 1.378 1 1.723V15a1 1 0 002 0v-2.277c.598-.345 1-.985 1-1.723zm-7 0c0-1.104-.896-2-2-2s-2 .896-2 2c0 .738.402 1.378 1 1.723V15a1 1 0 002 0v-2.277c.598-.345 1-.985 1-1.723zm14 0c0-1.104-.896-2-2-2s-2 .896-2 2c0 .738.402 1.378 1 1.723V15a1 1 0 002 0v-2.277c.598-.345 1-.985 1-1.723z"/>
            </svg>
            <h1 class="text-xl font-semibold">Pest Identification Chat</h1>
        </div>
        <div id="chat-container" class="chat-container flex-1 p-4">
            <div class="chat-message bot-message">
                Welcome to the Pest Identification Chat! Describe the pest issue you're facing, including symptoms and affected crops (e.g., "My tomato plants have yellowing leaves and sticky residue"), and I'll help identify the pest and provide a detailed report.
            </div>
        </div>
        <div class="input-area flex items-center space-x-2">
            <textarea
                id="message-input"
                placeholder="Describe the pest issue (e.g., 'Tomato leaves are yellowing with tiny white insects')"
                class="flex-1 p-2 border rounded-lg resize-none focus:outline-none focus:ring-2 focus:ring-green-500"
                rows="2"
            ></textarea>
            <button
                id="send-button"
                class="bg-green-600 text-white p-2 rounded-lg hover:bg-green-700 transition"
            >
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                </svg>
            </button>
            <button
                id="clear-button"
                class="bg-green-600 text-white p-2 rounded-lg hover:bg-green-700 transition"
            >
                Clear
            </button>
        </div>
    </div>

    <script>
        const chatContainer = document.getElementById('chat-container');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const clearButton = document.getElementById('clear-button');
        const API_URL = 'http://localhost:8000/identify-pest';
        let chartInstance = null;

        function scrollToBottom() {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function addMessage(content, type = 'bot') {
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${type === 'user' ? 'user-message' : type === 'error' ? 'error-message' : 'bot-message'}`;
            messageDiv.innerHTML = content;
            chatContainer.appendChild(messageDiv);
            scrollToBottom();
        }

        function addLoadingSpinner() {
            const spinnerDiv = document.createElement('div');
            spinnerDiv.id = 'loading-spinner';
            spinnerDiv.className = 'loading-spinner';
            chatContainer.appendChild(spinnerDiv);
            scrollToBottom();
            return spinnerDiv;
        }

        function removeLoadingSpinner() {
            const spinner = document.getElementById('loading-spinner');
            if (spinner) spinner.remove();
        }

        function formatReport(report) {
            const cleanReport = report.replace(/\*\*/g, '').replace(/:\s*$/, ':');
            const lines = cleanReport.split('\n').filter(line => line.trim());
            let formatted = '';
            let currentSection = '';
            let currentIndent = 0;

            for (const line of lines) {
                const trimmedLine = line.trim();
                if (!trimmedLine) {
                    formatted += '<div style="margin-bottom: 8px;"></div>';
                    continue;
                }

                const isHeader = trimmedLine.match(/^[A-Z][a-zA-Z\s]+(:)?$/) || trimmedLine === 'Pest Identification Report';
                if (isHeader) {
                    formatted += `<div class="report-header" onclick="toggleSection(this)">${trimmedLine.replace(/:$/, '')}</div>`;
                    currentSection = trimmedLine.replace(/:$/, '');
                    formatted += `<div class="collapsible" id="${currentSection.replace(/\s/g, '-')}-content">`;
                    currentIndent = 16;
                } else {
                    formatted += `<div class="report-subitem" style="margin-left: ${currentIndent}px;">${trimmedLine}</div>`;
                    if (!trimmedLine.startsWith('  ')) {
                        formatted += '</div>'; // Close collapsible section
                        currentIndent = 0;
                    }
                }
            }
            if (currentIndent > 0) formatted += '</div>'; // Ensure last section is closed
            return `<div class="report-content">${formatted}</div>`;
        }

        function toggleSection(header) {
            const content = header.nextElementSibling;
            if (content && content.classList.contains('collapsible')) {
                content.classList.toggle('active');
            }
        }

        function renderChart(chartData) {
            if (chartInstance) chartInstance.destroy();
            const canvas = document.createElement('canvas');
            canvas.id = 'pest-chart';
            canvas.style.maxHeight = '300px';
            const chartContainer = document.createElement('div');
            chartContainer.className = 'bot-message';
            chartContainer.appendChild(canvas);
            chatContainer.appendChild(chartContainer);
            chartInstance = new Chart(canvas, chartData);
            scrollToBottom();
        }

        async function sendMessage() {
            const description = messageInput.value.trim();
            if (!description) {
                addMessage('Please enter a description.', 'error');
                return;
            }

            addMessage(description, 'user');
            messageInput.value = '';
            const spinner = addLoadingSpinner();

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ description })
                });

                const data = await response.json();
                removeLoadingSpinner();

                if (response.ok) {
                    const content = `
                        <strong>Identified Pest:</strong> ${data.pest}<br>
                        <strong>Possible Pests:</strong> ${data.text_result.pests.map(p => `${p.pest} (${(p.confidence * 100).toFixed(0)}%)`).join(', ')}<br><br>
                        <strong>Detailed Report:</strong><br>
                        ${formatReport(data.report)}
                    `;
                    addMessage(content);
                    if (data.chart) renderChart(data.chart);
                } else {
                    let errorContent = 'An unknown error occurred.';
                    if (data.detail && typeof data.detail === 'object') {
                        if (data.detail.error) {
                            errorContent = data.detail.error;
                        }
                        if (data.detail.hint) {
                            errorContent += `<br><strong>Hint:</strong> ${data.detail.hint.replace(/\n/g, '<br>')}`;
                            messageInput.placeholder = data.detail.hint.split('\n')[0];
                        }
                    } else if (data.detail && typeof data.detail === 'string') {
                        try {
                            const parsedDetail = JSON.parse(data.detail);
                            if (parsedDetail.error) {
                                errorContent = parsedDetail.error;
                            }
                            if (parsedDetail.hint) {
                                errorContent += `<br><strong>Hint:</strong> ${parsedDetail.hint.replace(/\n/g, '<br>')}`;
                                messageInput.placeholder = parsedDetail.hint.split('\n')[0];
                            }
                        } catch (e) {
                            errorContent = data.detail;
                        }
                    }
                    addMessage(errorContent, 'error');
                }
            } catch (error) {
                console.error('Fetch Error:', error);
                removeLoadingSpinner();
                addMessage(
                    `Unable to connect to the server at ${API_URL}. Please ensure the API is running and accessible on localhost:8000.`,
                    'error'
                );
            }
        }

        function clearChat() {
            while (chatContainer.children.length > 1) {
                chatContainer.removeChild(chatContainer.lastChild);
            }
            if (chartInstance) {
                chartInstance.destroy();
                chartInstance = null;
            }
            messageInput.value = '';
            messageInput.placeholder = "Describe the pest issue (e.g., 'Tomato leaves are yellowing with tiny white insects')";
            scrollToBottom();
        }

        sendButton.addEventListener('click', sendMessage);
        clearButton.addEventListener('click', clearChat);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        scrollToBottom();
    </script>
</body>
</html>